<?php

define('DEFAULT_MAX_DURATION', 900);

class action {

    function record($module_name, $action_name = "access") {
        global $uid, $currentCourseID;
        $action_type = new action_type();
        $action_type_id = $action_type->get_action_type_id($action_name);
        $exit = $action_type->get_action_type_id('exit');
        $module_id = $this->get_module_id($module_name);

        //echo "el telephone";
        
        ###ophelia -28-08-2006 : add duration to previous
        // $sql = "SELECT id, TIME_TO_SEC(TIMEDIFF(NOW(), date_time)) AS diff, action_type_id
        //         FROM actions
        //         WHERE user_id = $uid
        //         ORDER BY id DESC LIMIT 1";
        $last_id = $diff = $last_action = 0;
        // $result = db_query($sql, $currentCourseID);

        if ($currentCourseID) {
            mysql_select_db($currentCourseID);
            $mysqli = mysqli_connect("db", "root", "1234", $currentCourseID);
            //echo "6";
        }
        else {
            $sql1='SELECT DATABASE()';
            $sqlresult=mysql_query($sql1);
            $row=mysql_fetch_row($sqlresult);
            $active_db=$row[0];

            $mysqli = mysqli_connect("db", "root", "1234", $active_db);
            //echo "6";                
        }
        
        $stmt = $mysqli->prepare("SELECT id, TIME_TO_SEC(TIMEDIFF(NOW(), date_time)) AS diff, action_type_id FROM actions WHERE user_id = ? ORDER BY id DESC LIMIT 1");
        if (!$stmt) {
            die('mysqli error: '.mysqli_error($mysqli));
        }
        // bind the parameters
        $stmt->bind_param("i", $uid);
        // execute the statement
        mysqli_stmt_execute($stmt);
        $result = mysqli_stmt_get_result($stmt);
        
        if ($result && mysqli_num_rows($result) > 0) {
            list($last_id, $diff, $last_action) = mysqli_fetch_row($result);
            mysqli_free_result($result);
            // Update previous action with correct duration
            if ($last_id && $last_action != $exit && $diff < DEFAULT_MAX_DURATION) {
                $sql1 = "UPDATE actions SET duration = ? WHERE id = ?";
                $stmt1 = $mysqli->prepare($sql1);
                $stmt1->bind_param("ii", $diff, $last_id);
                $stmt1->execute();
                $stmt1->close();
            }
        }
        if ($action_type_id == $exit) {
                $duration = 0;
        } else {
                $duration = DEFAULT_MAX_DURATION;
        }
        
        $sql = "INSERT INTO actions SET
                module_id = ?,
                user_id = ?,
                action_type_id = ?,
                date_time = NOW(),
                duration = ?";
        $stmt = $mysqli->prepare($sql);
        $stmt->bind_param("iiii", $module_id, $uid, $action_type_id, $duration);
        $stmt->execute();
        $stmt->close();
        $mysqli->close();
    }


#ophelia 2006-08-02: per month and per course
    function summarize() {
        global $currentCourseID;
        echo "a sante";
        
        ## edw ftia3e tis hmeromhnies
        $now = date('Y-m-d H:i:s');
        $current_month = date('Y-m-01 00:00:00');
        
        $sql_0 = "SELECT min(date_time) as min_date FROM actions";   //gia na doume
        $sql_1 = "SELECT DISTINCT module_id FROM actions ";  //arkei gia twra.
        // ayta ta query den xreiazontai prostasia giati den pernoun parametrous
 
        $result = db_query($sql_0, $currentCourseID);
        while ($row = mysql_fetch_assoc($result)) {
            $start_date = $row['min_date'];
        }
	if (empty($start_date)) {
		$start_date = '2003-01-01 00:00:00';
	}
        mysql_free_result($result);


    if ($currentCourseID) {
        mysql_select_db($currentCourseID);
        $conn = mysqli_connect("db", "root", "1234", $currentCourseID);
            //echo "6";
    }
    else {
        $sql1='SELECT DATABASE()';
        $sqlresult=mysql_query($sql1);
        $row=mysql_fetch_row($sqlresult);
        $active_db=$row[0];

        $conn = mysqli_connect("db", "root", "1234", $active_db);
            //echo "6";                
    }

	$stmp = strtotime($start_date);
        $end_stmp = $stmp + 31*24*60*60;  //min time + 1 month
        $end_date = date('Y-m-01 00:00:00', $end_stmp);
        while ($end_date < $current_month){
            $result = db_query($sql_1, $currentCourseID);
            while ($row = mysql_fetch_assoc($result)) {
                #edw kanoume douleia gia ka8e module
                $module_id = $row['module_id'];

                // $sql_2 = "SELECT count(id) as visits, sum(duration) as total_dur FROM actions ".
                //     " WHERE module_id = $module_id AND ".
                //     " date_time >= '$start_date' AND ".
                //     " date_time < '$end_date' ";
                    
                // $result_2 = db_query($sql_2, $currentCourseID);
                // while ($row2 = mysql_fetch_assoc($result_2)) {
                //     $visits = $row2['visits'];
                //     $total_dur = $row2['total_dur'];
                // }
                // mysql_free_result($result_2);
                // $sql_3 = "INSERT INTO actions_summary SET ".
                //     " module_id = $module_id, ".
                //     " visits = $visits, ".
                //     " start_date = '$start_date', ".
                //     " end_date = '$end_date', ".
                //     " duration = $total_dur";
                // $result_3 = db_query($sql_3, $currentCourseID);
                // @mysql_free_result($result_3);
            
                // $sql_4 = "DELETE FROM actions ".
                //     " WHERE module_id = $module_id ".
                //     " AND date_time >= '$start_date' AND ".
                //     " date_time < '$end_date'";
                // $result_4 = db_query($sql_4, $currentCourseID);
                // @mysql_free_result($result_4);
                $sql_2 = "SELECT count(id) as visits, sum(duration) as total_dur FROM actions WHERE module_id = ? AND date_time >= ? AND date_time < ?";
                $stmt_2 = mysqli_prepare($conn, $sql_2);
                mysqli_stmt_bind_param($stmt_2, "iss", $module_id, $start_date, $end_date);
                mysqli_stmt_execute($stmt_2);
                $result_2 = mysqli_stmt_get_result($stmt_2);
                while ($row2 = mysqli_fetch_assoc($result_2)) {
                    $visits = $row2['visits'];
                    $total_dur = $row2['total_dur'];
                }
                mysqli_free_result($result_2);

                $sql_3 = "INSERT INTO actions_summary SET module_id = ?, visits = ?, start_date = ?, end_date = ?, duration = ?";
                $stmt_3 = mysqli_prepare($conn, $sql_3);
                mysqli_stmt_bind_param($stmt_3, "iisss", $module_id, $visits, $start_date, $end_date, $total_dur);
                mysqli_stmt_execute($stmt_3);
                mysqli_stmt_close($stmt_3);

                $sql_4 = "DELETE FROM actions WHERE module_id = ? AND date_time >= ? AND date_time < ?";
                $stmt_4 = mysqli_prepare($conn, $sql_4);
                mysqli_stmt_bind_param($stmt_4, "iss", $module_id, $start_date, $end_date);
                mysqli_stmt_execute($stmt_4);
                mysqli_stmt_close($stmt_4);            
            }
            mysql_free_result($result);
            
            #next month
            $start_date = $end_date;
	        $stmp = $end_stmp;	
            $end_stmp += 31*24*60*60;  //end time + 1 month
            $end_date = date('Y-m-01 00:00:00', $end_stmp);
	        $start_date = date('Y-m-01 00:00:00', $stmp);
        }
        mysqli_close($conn);
    }



   
    function get_module_id($module_name) {
        global $currentCourseID;
        $sql = "SELECT id FROM accueil WHERE define_var = ?";
        
        if ($currentCourseID) {
            mysql_select_db($currentCourseID);
            $conn = mysqli_connect("db", "root", "1234", $currentCourseID);
        }
        else {
            $sql1='SELECT DATABASE()';
            $sqlresult=mysql_query($sql1);
            $row=mysql_fetch_row($sqlresult);
            $active_db=$row[0];

            $conn = mysqli_connect("db", "root", "1234", $active_db);
        }

            $stmt = mysqli_prepare($conn, $sql);
            if (!$stmt) {
                die('mysqli error: '.mysqli_error($conn));
            }
    
            mysqli_stmt_bind_param($stmt, "s", $module_name);
            mysqli_stmt_execute($stmt);
            $result = mysqli_stmt_get_result($stmt);
            if ($result && mysqli_num_rows($result) > 0) {
                list($id) = mysqli_fetch_row($result);
                mysqli_free_result($result);
                mysqli_stmt_close($stmt);
                mysqli_close($conn);
                return $id;
            } else {
                mysqli_stmt_close($stmt);
                mysqli_close($conn);
                return 0;
            }   
    }

}

class action_type {

    function get_action_type_id($action_name) {
        global $currentCourseID;

        //echo "zz";
        
        if ($currentCourseID) {
            mysql_select_db($currentCourseID);
            $mysqli = mysqli_connect("db", "root", "1234", $currentCourseID);
        }
        else {
            $sql1='SELECT DATABASE()';
            $sqlresult=mysql_query($sql1);
            $row=mysql_fetch_row($sqlresult);
            $active_db=$row[0];

            $mysqli = mysqli_connect("db", "root", "1234", $active_db);
        }

        $stmt = $mysqli->prepare("SELECT id FROM action_types WHERE name = ?");
        $stmt->bind_param("s", $action_name);
        $stmt->execute();
        $stmt->store_result();
        if ($stmt->num_rows > 0) {
          $stmt->bind_result($id);
          $stmt->fetch();
          $stmt->free_result();
          $mysqli->close();
          return $id;
        } else {
          $stmt->free_result();
          $mysqli->close();
          return false;
        }
      }
      
}
