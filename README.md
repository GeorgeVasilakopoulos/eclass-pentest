## Open eClass 2.3

Το repository αυτό περιέχει μια __παλιά και μη ασφαλή__ έκδοση του eclass.
Προορίζεται για χρήση στα πλαίσια του μαθήματος
[Προστασία & Ασφάλεια Υπολογιστικών Συστημάτων (ΥΣ13)](https://ys13.chatzi.org/), __μην τη
χρησιμοποιήσετε για κάνενα άλλο σκοπό__.


### Χρήση μέσω docker
```
# create and start (the first run takes time to build the image)
docker-compose up -d

# stop/restart
docker-compose stop
docker-compose start

# stop and remove
docker-compose down -v
```

To site είναι διαθέσιμο στο http://localhost:8001/. Την πρώτη φορά θα πρέπει να τρέξετε τον οδηγό εγκατάστασης.


### Ρυθμίσεις eclass

Στο οδηγό εγκατάστασης του eclass, χρησιμοποιήστε __οπωσδήποτε__ τις παρακάτω ρυθμίσεις:

- Ρυθμίσεις της MySQL
  - Εξυπηρέτης Βάσης Δεδομένων: `db`
  - Όνομα Χρήστη για τη Βάση Δεδομένων: `root`
  - Συνθηματικό για τη Βάση Δεδομένων: `1234`
- Ρυθμίσεις συστήματος
  - URL του Open eClass : `http://localhost:8001/` (προσοχή στο τελικό `/`)
  - Όνομα Χρήστη του Διαχειριστή : `drunkadmin`

Αν κάνετε κάποιο λάθος στις ρυθμίσεις, ή για οποιοδήποτε λόγο θέλετε να ρυθμίσετε
το openeclass από την αρχή, διαγράψτε το directory, `openeclass/config` και ο
οδηγός εγκατάστασης θα τρέξει ξανά.

## 2023 Project 1

Εκφώνηση: https://ys13.chatzi.org/assets/projects/project1.pdf


### Μέλη ομάδας

- 1115202000018, Γεώργιος-Αλέξανδρος Βασιλακόπουλος
- ΑΜ, όνομα

### Report

Συμπληρώστε εδώ __ένα report__ που
- Να εξηγεί τι είδους αλλαγές κάνατε στον κώδικα για να προστατέψετε το site σας (από την κάθε επίθεση).
- Να εξηγεί τι είδους επιθέσεις δοκιμάσατε στο αντίπαλο site και αν αυτές πέτυχαν.


### Defences


#### CSRF 

Numerous CSRF vulnerabilities were detected, accross many different modules of the platform. More specifically, requests that were made through forms in the admin side were completely exposed to such attacks and, in some extreme cases, simple GET requests could be used to change the state of the server.

In order to patch these vulnerabilities, we implemeneted CSRF token authentication. All state changing forms should now contain a hidden 'token' field that was provided by the server through a non state-changing GET request, while state-changing GET requests should include the token in the URL.

Below is a list of most of the patched files/directories. In total 62 files were changed:

- ```modules/admin/change_user.php``` 
- ```modules/admin/listreq.php```: Prevented the status change of registration requests through CSRF.
- ```modules/admin/listusers.php```, ```modules/admin/search_user.php```: Prevents user searches through CSRF.

- ```modules/admin/multireguser.php```: Prevented the registration of multiple users through CSRF

- ```modules/admin/newuseradmin.php```: Prevented the registration of a new admin.

- ```modules/admin/password.php```: Prevented password change of users (or even admin).

- ```modules/admin/unreguser.php```: Prevented the deletion of an account.

- ```modules/admin/edituser.php```: Prevented altering user information.

- ```modules/admin/mailtoprof.php```: Prevented email sending.

- ```modules/admin/addfaculte.php```: Prevented the creation/deletion of a department/faculty

- ```modules/admin/adminannouncements.php```: Prevented creation/edit/removal of an admin announcement

- ```modules/admin/eclassconf.php```: Prevented submission of malicious configuration settings.

- ```modules/admin/listcours.php```: Prevented the submission of a search.

- ```modules/admin/delcours.php```: Prevented the deletion of a course.

- ```modules/admin/editcours.php```, ```modules/admin/infocours.php``` 

- ```modules/admin/infocours.php```: Prevented altering course information.

- ```modules/admin/addusertocours.php```: Prevented granting admin access to course.

- ```modules/admin/quotacours.php```: Prevented altering course quota.

- ```modules/announcements/announcements.php```: Prevented the submission of an announcement in a course.

- In ```modules/exercise/```,files: ```admin.php```, ```answer_admin_inc.php```, ```exercise.php```, ```exercise_admin.php```, ```question_admin.php```, ```question_list_admin.inc.php```, ```question_list_admin.inc.php```, ```question_pool.php```, ```statement_admin.inc.php```: Secured the exercise module of a course.


- In ```modules/course_info/```, files : ```course_create.php```,```delete_course.php```, ```refresh_course.php```, ```infocours.php```, ```restore_course.php```, ```course_tools.php```: Prevented course changing actions/ creation of course.

- In ```modules/agenda/agenda.php``` : ```agenda.php```: Prevented the creation of an event.

- In ```modules/document/``` : ```document.php```, ```upload.php```: Secured the document module from CSRF attacks.

- In ```modules/forum_admin/``` : ```forum_admin.php```: Prevented the creation of a category

- In ```profile/profile.php```: Prevented change of user credentials.

- In ```modules/group/``` : ```document.php```, ```group.php```, ```group_creation.php```, ```group_edit.php```, ```group_space.php```: Secured the group module.

- In ```modules/video/```: Secured the video module.

- In ```modules/work/```: Secured the work module.

- In ```modules/wiki/```: Secured the wiki module.

- In ```modules/phpbb/```: Secured the phpbb module.



#### XSS

In this version of the platform, there were many XSS vulnerabilities that could be exploited, both *stored* and *reflected*. Since most of the admin side is protected by CSRF token authentication, there were fewer *reflected* XSS vulnerabilites that could be exploited. These were some obscure cases where the request did not change the state of the server and therefore, did not require authentication.

- In places where user information (such as name, last name) was displayed, the output was not filtered for html characters. Therefore, if a user set malicious html code as personal info, this code would be executed in places where the personal info was displayed. Characteristic examples of such places are: 

  - listing of users (```/admin/listusers.php```) 
  - listing of teacher requests (```/admin/listreq.php```)
  - management of users in courses (```/user```)
  - admin information (such as statistics, 'last user registration' etc)
  - in the confirmation of deletion of a user (```admin/unreguser.php```)

- In the forum section of a course (```/modules/mathbb```), neither the users' credentials, nor their activity (posts/answers) was escaped for html characters. The navigation bar was also prone to attacks. 

- The conference section, for the same reason, was vulnerable to stored XSS attacks.

- In the assignment section, the users' comments was not sanitized - stored XSS vulnerability. Also, a reflected XSS attack could be triggered by setting malicious code as argument in ```&submission=```. Example: ```http://localhost:8001/modules/work/grade_edit.php?assignment=1&submission=></script><script>alert(1)</script><``` 

- The calendar (!) was also prone to reflected XSS attacks, by assigning malicious code to the ```&year=``` url argument. 

- The inactive course modules were also patched for stored XSS attacks



#### RFI/LFI

Furthermore, we came across a few cases where a user could upload a file that could either be executed by the server (php files, if requested through the url) or by the admin's browser (such as html files). These instances were located in the assignments and dropbox modules. The vulnerabilities, along with the security measures that we took were the following:

- When a user clicks on a file received from the dropbox module, the file immediately gets downloaded. We noticed that file types such html don't get downloaded and, instead, are displayed as pages in the browser. This is a hazard, since the files could contain malicious javascript code.

- We turned off directory listing (```conf/000-default.conf```) because this would allow the user to manually direct the server to execute uploaded php code. 

- When an assignment is submitted by a student, the submitted file gets uploaded in a 'secret' folder within ```courses/TMA***/work```. The problem was that the assigned name of the folder was the output of ```uniqid("")``` which is very predictable, since it is based upon the current time in microseconds (at the time of creation of the assignment). We chose to name the files using a much larger, random hexadecimal string, using ```bin2hex(openssl_random_pseudo_bytes())```. Dropbox files also get renamed similarly, so that they cannot be easily found through the url.

- Also, uploaded .php .html .js .css files get converted to .php_secure .html_secure .js_secure .css_secure respectively. 

#### SQL Injections
Τhe main strategies we used to avoid SQL injections are the transformation of commands to use prepared statements, and the use of escaping functions such as intval() and mysql_real_escape_string(). 

We have secured from sql injection the modules that the user sees directly as well as the openclass/index.php file. More detailed 

- ```modules/work/```: Secured the work module.

- ```modules/phpbb/```: Secured the phpbb module.

- ```modules/unreguser/```: Secured the unreguser module.

- ```modules/search/```: Secured the search module.

- ```modules/profile/```: Secured the profile module.

- ```modules/link/```: Secured the link module.

- ```modules/forum_admin/```: Secured the forum_admin module.

- ```modules/dropbox/```: Secured the dropbox module.

- ```modules/agenda/```: Secured the agenda module.
dules/announcements/```: Secured the announcements module.

- ```modules/auth/```: Secured the auth module.

- ```openclass/index.php``` : Secured file.


In addition, we have secured from sql injection the following files that are used as libraries:

- In ```openclass/include/lib```: Secured files ```main.lib.php```, ```fileDisplayLib.inc.php```, ```fileManageLib.inc.php```. Special emphasis was given in main.lib.php.

- In ```openclass/include``` : Secured files ```actions.php```, ```classic.php```, ```init.php```, ```login.php```, ```person.php```, ```tools.php```.


Finally, we have secured the following files to which the user does not have direct access, in order to avoid attacks resulting from a combination of SQL injection and CSRF. 

- In ```modules/admin``` : Secured files ```addfaculte.php```, ```addusertocours.php```, ```adminannouncements.php```, ```change_user.php```, ```delcourse.php```, ```editcours.php```, ```edituser.php```, ```index.php```, ```infocours.php```, ```listreq.php```, ```listusers.php```, ```monthlyReport.php```, ```multireguser.php```, ```newuseradmin.php```, ```password.php```, ```statsForm.php```, ```unreguser.php```.

- In ```modules/user/```: Secured the user module.

- In ```modules/create_course/```: Secured the create_course module.

- In ```modules/exersice/```: Secured the exersice module.

- In ```modules/video/```: Secured the video module.

- In ```modules/wiki/```: Secured the wiki module.

- In ```modules/usage/```: Secured the usage module.

- In ```modules/course_home/```: Secured the wiki course_home (course_home.php).

- In ```modules/contact/```: Secured the contact module (index.php).

- In ```modules/course_info/```: Secured the course_info module.

- In ```modules/perso/```: Secured the perso module.


Some of the vulnerabilities that we found are: 

- in the Forum Section, where we can use a url like the following ```/modules/phpbb/viewtopic.php?topic=' union select password as topic_title, 1 from eclass.user-- &forum=1')-- ``` and the password would display as the topic title in the forums.
- upgrade.php

- ```modules/auth/```: Secured the auth module.

- ```modules/announcements/```: Secured the announcements module.

- ```modules/auth/```: Secured the auth module.

- ```openclass/index.php``` : Secured file.


In addition, we have secured from sql injection the following files that are used as libraries:

- In ```openclass/include/lib```: Secured files ```main.lib.php```, ```fileDisplayLib.inc.php```, ```fileManageLib.inc.php```. Special emphasis was given in main.lib.php.

- In ```openclass/include``` : Secured files ```actions.php```, ```classic.php```, ```init.php```, ```login.php```, ```person.php```, ```tools.php```.


Finally, we have secured the following files to which the user does not have direct access, in order to avoid attacks resulting from a combination of SQL injection and CSRF. 

- In ```modules/admin``` : Secured files ```addfaculte.php```, ```addusertocours.php```, ```adminannouncements.php```, ```change_user.php```, ```delcourse.php```, ```editcours.php```, ```edituser.php```, ```index.php```, ```infocours.php```, ```listreq.php```, ```listusers.php```, ```monthlyReport.php```, ```multireguser.php```, ```newuseradmin.php```, ```password.php```, ```statsForm.php```, ```unreguser.php```.

- In ```modules/user/```: Secured the user module.

- In ```modules/create_course/```: Secured the create_course module.

- In ```modules/exersice/```: Secured the exersice module.

- In ```modules/video/```: Secured the video module.

- In ```modules/wiki/```: Secured the wiki module.

- In ```modules/usage/```: Secured the usage module.

- In ```modules/course_home/```: Secured the wiki course_home (course_home.php).

- In ```modules/contact/```: Secured the contact module (index.php).

- In ```modules/course_info/```: Secured the course_info module.

- In ```modules/perso/```: Secured the perso module.


Some of the vulnerabilities that we found are: 

- in the Forum Section, where we can use a url like the following ```/modules/phpbb/viewtopic.php?topic=' union select password as topic_title, 1 from eclass.user-- &forum=1')-- ``` and the password would display as the topic title in the forums.
- ```upgrade/index.php``` every field in this form is SQLi-prone.




#### Other Security Measures

- We decided to add salt to the passwords, so that common passwords can't be decrypted through online databases.

- If the admin tries to change password through ```http://localhost:8001/modules/admin/edituser.php?u=1```, the page redirects to ```http://localhost:8001/modules/profile/password.php```. Previously, the admin could change his password through edituser without having to type his current password. This was a big risk because if someone managed to steal the cookie from the admin, they could simply change the password and gain permanent access.

- The deletion of a user also requires password verification. Previously, a user could be deleted simply by 'clicking the wrong link'.
